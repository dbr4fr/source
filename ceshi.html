<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance USDT 永续合约 Sound Alert</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .monitor-section {
            border: 1px solid #555;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        .inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        input {
            padding: 10px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .toggle-btn {
            background: #4CAF50;
        }
        .toggle-btn.stop {
            background: #f44336;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .volume-control label {
            font-size: 14px;
        }
        .volume-control input[type="range"] {
            flex: 1;
            height: 5px;
            background: #555;
            border-radius: 5px;
            outline: none;
        }
        .volume-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 15px;
            height: 15px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }
        .price-display {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
        }
        .trade-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .buy-btn, .sell-btn {
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
        }
        .buy-btn {
            background: #4CAF50;
        }
        .sell-btn {
            background: #f44336;
        }
        .status {
            text-align: center;
            margin-bottom: 20px;
        }
        .log {
            background: #333;
            padding: 10px;
            height: 150px;
            overflow-y: scroll;
            border-radius: 5px;
        }
        .audio-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }
        .note {
            font-size: 12px;
            color: #ccc;
            margin-top: -5px;
        }
        .dynamic-files {
            font-size: 14px;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .unlock-note {
            font-size: 12px;
            color: #ff9800;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Binance USDT 永续合约 Sound Alert</h1>
            <p>实时监控 Binance USDT 永续合约聚合交易，超过阈值时发出声音警报</p>
            <p class="note">音频文件从 GitHub 远程加载：https://raw.githubusercontent.com/dbr4fr/source/main/{id}_{side}.mp3</p>
        </div>

        <!-- 音量控制（共享） -->
        <div class="volume-control">
            <label for="volume">音量: <span id="volumeValue">50</span>%</label>
            <input type="range" id="volume" min="0" max="100" value="50">
        </div>

        <!-- 监控部分 1 -->
        <div class="monitor-section">
            <div class="section-title">监控 1</div>
            <div class="inputs">
                <input type="text" id="symbol1" placeholder="交易对 (e.g., BTCUSDT)" value="BTCUSDT">
                <input type="number" id="threshold1" placeholder="交易量阈值 (e.g., 10)" value="10" step="0.01">
                <button id="toggleBtn1" class="toggle-btn" onclick="toggleMonitoring(1)">停止监控</button>
            </div>

            <div id="dynamicFiles1" class="dynamic-files">当前音频文件: 1_buy.mp3 / 1_sell.mp3 (远程 GitHub)</div>

            <div class="audio-section">
                <label>BUY 声音文件: 1_buy.mp3</label>
                <div class="note">远程加载: https://raw.githubusercontent.com/dbr4fr/source/main/1_buy.mp3</div>
            </div>
            
            <div class="audio-section">
                <label>SELL 声音文件: 1_sell.mp3</label>
                <div class="note">远程加载: https://raw.githubusercontent.com/dbr4fr/source/main/1_sell.mp3</div>
            </div>

            <div class="unlock-note" id="unlockNote1" style="display: none;">点击样本按钮测试音频（尤其安卓）</div>
            
            <div class="price-display">
                <div>当前价格: <span id="currentPrice1">0.00</span> USDT</div>
            </div>
            
            <div class="trade-buttons">
                <button class="buy-btn" onclick="playBuySound(1)">播放 BUY 样本声音</button>
                <button class="sell-btn" onclick="playSellSound(1)">播放 SELL 样本声音</button>
            </div>
            
            <div class="status" id="status1">监控中...</div>
            
            <div class="log" id="log1"></div>
        </div>

        <!-- 监控部分 2 -->
        <div class="monitor-section">
            <div class="section-title">监控 2</div>
            <div class="inputs">
                <input type="text" id="symbol2" placeholder="交易对 (e.g., ETHUSDT)" value="ETHUSDT">
                <input type="number" id="threshold2" placeholder="交易量阈值 (e.g., 5)" value="5" step="0.01">
                <button id="toggleBtn2" class="toggle-btn" onclick="toggleMonitoring(2)">停止监控</button>
            </div>

            <div id="dynamicFiles2" class="dynamic-files">当前音频文件: 2_buy.mp3 / 2_sell.mp3 (远程 GitHub)</div>

            <div class="audio-section">
                <label>BUY 声音文件: 2_buy.mp3</label>
                <div class="note">远程加载: https://raw.githubusercontent.com/dbr4fr/source/main/2_buy.mp3</div>
            </div>
            
            <div class="audio-section">
                <label>SELL 声音文件: 2_sell.mp3</label>
                <div class="note">远程加载: https://raw.githubusercontent.com/dbr4fr/source/main/2_sell.mp3</div>
            </div>

            <div class="unlock-note" id="unlockNote2" style="display: none;">点击样本按钮测试音频（尤其安卓）</div>
            
            <div class="price-display">
                <div>当前价格: <span id="currentPrice2">0.00</span> USDT</div>
            </div>
            
            <div class="trade-buttons">
                <button class="buy-btn" onclick="playBuySound(2)">播放 BUY 样本声音</button>
                <button class="sell-btn" onclick="playSellSound(2)">播放 SELL 样本声音</button>
            </div>
            
            <div class="status" id="status2">监控中...</div>
            
            <div class="log" id="log2"></div>
        </div>
    </div>

    <script>
        // 全局 AudioContext
        let audioContext = null;
        let currentVolume = 0.5;
        const volumeSlider = document.getElementById('volume');
        const volumeValue = document.getElementById('volumeValue');

        // 音频缓冲
        const audioBuffers = {1: {buy: null, sell: null}, 2: {buy: null, sell: null}};

        // 保存/加载配置（每个监控独立）
        function saveConfig(id) {
            const symbol = document.getElementById(`symbol${id}`).value;
            const threshold = document.getElementById(`threshold${id}`).value;
            localStorage.setItem(`symbol${id}`, symbol);
            localStorage.setItem(`threshold${id}`, threshold);
        }

        function loadConfig(id) {
            const savedSymbol = localStorage.getItem(`symbol${id}`) || (id === 1 ? 'BTCUSDT' : 'ETHUSDT');
            const savedThreshold = localStorage.getItem(`threshold${id}`) || (id === 1 ? '10' : '5');
            document.getElementById(`symbol${id}`).value = savedSymbol;
            document.getElementById(`threshold${id}`).value = savedThreshold;
        }

        // 更新音量显示
        function updateVolumeDisplay(value) {
            volumeValue.textContent = value;
        }

        // 音量滑块事件（共享）
        volumeSlider.addEventListener('input', function() {
            const vol = parseInt(this.value);
            updateVolumeDisplay(vol);
            currentVolume = vol / 100;
            localStorage.setItem('volume', vol);
        });

        // 初始化音量
        function initVolume() {
            const savedVolume = localStorage.getItem('volume') || '50';
            volumeSlider.value = savedVolume;
            updateVolumeDisplay(savedVolume);
            currentVolume = parseFloat(savedVolume) / 100;
        }

        // 初始化 AudioContext
        function initAudioContext() {
            if (audioContext) return;
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') {
                // 尝试 resume（可能需要交互，但页面加载时尝试）
                audioContext.resume().then(() => {
                    console.log('AudioContext resumed');
                }).catch(e => {
                    console.log('AudioContext resume failed:', e);
                });
            }
        }

        // 加载远程 MP3 到 buffer
        async function loadAudioBuffer(id, side) {
            const baseUrl = 'https://raw.githubusercontent.com/dbr4fr/source/main/';
            const file = `${id}_${side}.mp3`;
            const url = baseUrl + file;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const arrayBuffer = await response.arrayBuffer();
                const buffer = await audioContext.decodeAudioData(arrayBuffer);
                audioBuffers[id][side] = buffer;
                return buffer;
            } catch (e) {
                console.error(`加载 ${file} 失败:`, e);
                return null;
            }
        }

        // 使用 buffer 播放
        function playBuffer(id, isBuy) {
            if (!audioContext || audioContext.state === 'suspended') {
                audioContext.resume().catch(() => {}); // 尝试 resume
            }
            const buffer = audioBuffers[id][isBuy ? 'buy' : 'sell'];
            if (!buffer) {
                playBeepFallback(isBuy ? 800 : 400);
                return;
            }
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            const gainNode = audioContext.createGain();
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.gain.value = currentVolume;
            source.start(0);
        }

        // 回退 beep
        function playBeepFallback(frequency, duration = 200) {
            const tempContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = tempContext.createOscillator();
            const gainNode = tempContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(tempContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(currentVolume * 0.3, tempContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(currentVolume * 0.01, tempContext.currentTime + duration / 1000);
            
            oscillator.start(tempContext.currentTime);
            oscillator.stop(tempContext.currentTime + duration / 1000);
        }

        // 播放声音（通用，带 id）
        function playSound(id, isBuy) {
            initAudioContext();
            playBuffer(id, isBuy);
        }

        function playBuySound(id) {
            playSound(id, true);
        }

        function playSellSound(id) {
            playSound(id, false);
        }

        // 日志函数（带 id）
        function addLog(id, message) {
            const logElement = document.getElementById(`log${id}`);
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 监控对象（每个 id 一个）
        const monitors = {
            1: { ws: null, isMonitoring: false, reconnectTimeout: null, reconnectDelay: 1000, reconnectAttempts: 0, manualStop: false },
            2: { ws: null, isMonitoring: false, reconnectTimeout: null, reconnectDelay: 1000, reconnectAttempts: 0, manualStop: false }
        };

        const maxReconnectAttempts = 10;
        const maxReconnectDelay = 30000;

        // 重连调度（带 id）
        function scheduleReconnect(id) {
            const monitor = monitors[id];
            if (monitor.reconnectAttempts >= maxReconnectAttempts) {
                addLog(id, `重连尝试次数超过 ${maxReconnectAttempts}，停止自动重连。请手动重启监控。`);
                monitors[id].isMonitoring = false;
                document.getElementById(`toggleBtn${id}`).textContent = '开始监控';
                document.getElementById(`toggleBtn${id}`).classList.remove('stop');
                document.getElementById(`status${id}`).textContent = '重连失败：超过最大尝试次数';
                return;
            }

            monitor.reconnectAttempts++;
            monitor.reconnectDelay = Math.min(monitor.reconnectDelay * 2, maxReconnectDelay);
            addLog(id, `连接断开，尝试第 ${monitor.reconnectAttempts} 次重连 (延迟 ${monitor.reconnectDelay / 1000}s)...`);

            if (monitor.reconnectTimeout) clearTimeout(monitor.reconnectTimeout);
            monitor.reconnectTimeout = setTimeout(() => {
                startMonitoring(id);
            }, monitor.reconnectDelay);
        }

        // 开始监控（带 id）
        async function startMonitoring(id) {
            const inputSymbol = document.getElementById(`symbol${id}`).value;
            const symbol = inputSymbol.toLowerCase();
            const threshold = parseFloat(document.getElementById(`threshold${id}`).value);
            
            if (!inputSymbol || isNaN(threshold)) {
                alert(`请正确输入交易对和阈值 (监控 ${id})`);
                return;
            }

            saveConfig(id);

            const monitor = monitors[id];
            monitor.manualStop = false; // 重置手动停止标志

            // 预加载音频 buffer
            initAudioContext();
            const buyBuffer = await loadAudioBuffer(id, 'buy');
            const sellBuffer = await loadAudioBuffer(id, 'sell');
            if (buyBuffer) addLog(id, `BUY 音频 buffer 加载成功`);
            if (sellBuffer) addLog(id, `SELL 音频 buffer 加载成功`);
            if (!buyBuffer && !sellBuffer) addLog(id, '音频 buffer 加载失败，使用 beep 回退');

            if (monitor.ws) {
                monitor.ws.close();
            }

            const stream = `${symbol}@aggTrade`;
            monitor.ws = new WebSocket(`wss://fstream.binance.com/ws/${stream}`);

            monitor.ws.onopen = () => {
                monitor.isMonitoring = true;
                document.getElementById(`toggleBtn${id}`).textContent = '停止监控';
                document.getElementById(`toggleBtn${id}`).classList.add('stop');
                document.getElementById(`status${id}`).textContent = `监控中: ${inputSymbol} USDT 永续合约 阈值: ${threshold}`;
                monitor.reconnectAttempts = 0;
                monitor.reconnectDelay = 1000;
                if (monitor.reconnectTimeout) {
                    clearTimeout(monitor.reconnectTimeout);
                    monitor.reconnectTimeout = null;
                }
                addLog(id, `开始监控 ${inputSymbol} USDT 永续合约，阈值 ${threshold}`);
            };

            monitor.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const price = parseFloat(data.p);
                const quantity = parseFloat(data.q);
                const isBuyerMaker = data.m;

                document.getElementById(`currentPrice${id}`).textContent = price.toFixed(2);

                if (quantity > threshold) {
                    const side = isBuyerMaker ? 'SELL' : 'BUY';
                    addLog(id, `${side} 大单: 价格 ${price}, 量 ${quantity}`);
                    
                    if (side === 'BUY') {
                        playBuySound(id);
                    } else {
                        playSellSound(id);
                    }
                }
            };

            monitor.ws.onclose = (event) => {
                console.log(`WebSocket ${id} 关闭:`, event.code, event.reason);
                monitor.isMonitoring = false;
                document.getElementById(`toggleBtn${id}`).textContent = '开始监控';
                document.getElementById(`toggleBtn${id}`).classList.remove('stop');
                document.getElementById(`status${id}`).textContent = '连接关闭，正在重连...';
                addLog(id, 'WebSocket 连接关闭');
                if (!monitor.manualStop) {
                    scheduleReconnect(id);
                }
            };

            monitor.ws.onerror = (error) => {
                console.error(`WebSocket ${id} 错误:`, error);
                monitor.isMonitoring = false;
                document.getElementById(`toggleBtn${id}`).textContent = '开始监控';
                document.getElementById(`toggleBtn${id}`).classList.remove('stop');
                document.getElementById(`status${id}`).textContent = '连接错误，正在重连...';
                addLog(id, 'WebSocket 连接错误');
                if (!monitor.manualStop) {
                    scheduleReconnect(id);
                }
            };
        }

        // 停止监控（带 id）
        function stopMonitoring(id) {
            const monitor = monitors[id];
            if (monitor.ws) {
                monitor.ws.close();
            }
            if (monitor.reconnectTimeout) {
                clearTimeout(monitor.reconnectTimeout);
                monitor.reconnectTimeout = null;
            }
            monitor.reconnectAttempts = 0;
            monitor.reconnectDelay = 1000;
            monitor.manualStop = true; // 设置手动停止标志，避免重连
            monitor.isMonitoring = false;
            document.getElementById(`toggleBtn${id}`).textContent = '开始监控';
            document.getElementById(`toggleBtn${id}`).classList.remove('stop');
            document.getElementById(`status${id}`).textContent = '已停止监控';
            addLog(id, '停止监控');
        }

        // 切换监控（带 id）
        function toggleMonitoring(id) {
            const monitor = monitors[id];
            if (monitor.isMonitoring) {
                stopMonitoring(id);
            } else {
                startMonitoring(id);
            }
        }

        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            initVolume();
            [1, 2].forEach(id => {
                loadConfig(id);
                startMonitoring(id);
            });
        });
    </script>
</body>
</html>